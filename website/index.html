<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Management System Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-bg: #271B2C;
            --card-bg: #3A2A40;
            --text-color: #F5F5F5;
            --accent-1: #FF6B9D;
            --accent-2: #4ECDC4;
            --accent-3: #FFD166;
            --accent-4: #744577;
            --accent-5: #118AB2;
            --accent-6: #FF8C42; /* ADDED: For current chart */
        }
        
        body {
            background-color: var(--primary-bg);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            margin: 0;
            color: var(--accent-2);
        }
        
        .subtitle {
            color: var(--accent-1);
            margin-top: 5px;
        }
        
        .config-section {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .config-item {
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid var(--accent-2);
        }
        
        .config-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--accent-2);
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--accent-1);
            text-align: center;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .status-item {
            text-align: center;
            flex: 1;
        }
        
        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-2);
        }
        
        .status-label {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--accent-2);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Battery Management System Dashboard</h1>
            <p class="subtitle">Real-time monitoring and analysis of battery performance</p>
        </header>
        
        <div class="status-bar" id="statusBar">
            <div class="status-item">
                <div class="status-value" id="currentSOC">--%</div>
                <div class="status-label">Overall SOC</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="currentSOH">--%</div>
                <div class="status-label">Overall SOH</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="currentTemp">--째C</div>
                <div class="status-label">Pack Temperature</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="currentRange">-- km</div>
                <div class="status-label">Estimated Range</div>
            </div>
        </div>
        
        <section class="config-section">
            <h2>Configuration Information</h2>
            <div class="config-grid" id="configGrid">
                <!-- Configuration will be populated by JavaScript -->
                <div class="loading">Loading configuration data...</div>
            </div>
        </section>
        
        <section class="charts-section">
            <div class="chart-container">
                <h3 class="chart-title">Pack State of Charge</h3>
                <canvas id="socChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Pack State of Health</h3>
                <canvas id="sohChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Cell State of Charge</h3>
                <canvas id="cellSocChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Cell State of Health</h3>
                <canvas id="cellSohChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Pack Temperature</h3>
                <canvas id="tempChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Pack Range</h3>
                <canvas id="rangeChart"></canvas>
            </div>
            
            <!-- ADDED: Pack Current Chart -->
            <div class="chart-container">
                <h3 class="chart-title">Pack Current</h3>
                <canvas id="currentChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Acceleration Behavior</h3>
                <canvas id="accelChart"></canvas>
            </div>
        </section>
        
        <footer>
            <p>BMS Dashboard | Last Updated: <span id="lastUpdate">Loading...</span></p>
        </footer>
    </div>

    <script>
        // Global variables to store chart instances and data
        let charts = {};
        let bmsData = null;

        // Load data from JSON file
        async function loadBMSData() {
            try {
                const response = await fetch('data/processed_data.json');
                bmsData = await response.json();
                
                // Update last update time
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                
                // Update status bar with latest values
                updateStatusBar();
                
                // Populate configuration
                populateConfiguration();
                
                // Initialize charts with real data
                initializeCharts();
                
            } catch (error) {
                console.error('Error loading BMS data:', error);
                document.getElementById('lastUpdate').textContent = 'Error loading data';
                // Fallback to sample data if real data isn't available
                loadSampleData();
            }
        }

        function updateStatusBar() {
            if (bmsData && bmsData.time_series) {
                const ts = bmsData.time_series;
                const lastIndex = ts.timestamps.length - 1;
                
                if (lastIndex >= 0) {
                    document.getElementById('currentSOC').textContent = 
                        ts.packSOC[lastIndex].toFixed(1) + '%';
                    document.getElementById('currentSOH').textContent = 
                        ts.packSOH[lastIndex].toFixed(1) + '%';
                    document.getElementById('currentTemp').textContent = 
                        ts.packTemp[lastIndex].toFixed(1) + '째C';
                    document.getElementById('currentRange').textContent = 
                        ts.packRange[lastIndex].toFixed(0) + ' km';
                }
            }
        }

        function populateConfiguration() {
            if (bmsData && bmsData.config) {
                const config = bmsData.config;
                const configGrid = document.getElementById('configGrid');
                
                const configItems = [
                    { label: 'Battery Capacity', value: `${config.batteryCapacity} Ah` },
                    { label: 'Number of Cells', value: config.numCells },
                    { label: 'Cell Capacity [0]', value: `${config.cellCapacity[0]} Ah` },
                    { label: 'Cell Capacity [1]', value: `${config.cellCapacity[1]} Ah` },
                    { label: 'Cell Capacity [2]', value: `${config.cellCapacity[2]} Ah` },
                    { label: 'Cell Power [0]', value: `${config.cellPower[0]} Wh` },
                    { label: 'Cell Power [1]', value: `${config.cellPower[1]} Wh` },
                    { label: 'Cell Power [2]', value: `${config.cellPower[2]} Wh` },
                    { label: 'Initial SOC [0]', value: `${config.initialSOC[0]}%` },
                    { label: 'Initial SOC [1]', value: `${config.initialSOC[1]}%` },
                    { label: 'Initial SOC [2]', value: `${config.initialSOC[2]}%` },
                    { label: 'Initial SOH [0]', value: `${config.initialSOH[0]}%` },
                    { label: 'Initial SOH [1]', value: `${config.initialSOH[1]}%` },
                    { label: 'Initial SOH [2]', value: `${config.initialSOH[2]}%` },
                    { label: 'Degradation Rate [0]', value: `${config.degradationRate[0]}%/cycle` },
                    { label: 'Degradation Rate [1]', value: `${config.degradationRate[1]}%/cycle` },
                    { label: 'Degradation Rate [2]', value: `${config.degradationRate[2]}%/cycle` },
                    { label: 'Max Discharge Current', value: `${config.maxDischargeCurrent} A` },
                    { label: 'Max Charge Current', value: `${config.maxChargeCurrent} A` }
                ];

                configGrid.innerHTML = '';
                configItems.forEach(item => {
                    const configItem = document.createElement('div');
                    configItem.className = 'config-item';
                    configItem.innerHTML = `
                        <div class="config-title">${item.label}</div>
                        <div>${item.value}</div>
                    `;
                    configGrid.appendChild(configItem);
                });
            }
        }

        function formatTimeLabel(timestamp) {
            // Convert seconds to minutes:seconds format for better readability
            const minutes = Math.floor(timestamp / 60);
            const seconds = Math.floor(timestamp % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function initializeCharts() {
            if (!bmsData || !bmsData.time_series) {
                console.error('No time series data available');
                return;
            }

            const ts = bmsData.time_series;
            
            // Format timestamps for display
            const timeLabels = ts.timestamps.map(formatTimeLabel);

            // Destroy existing charts if they exist
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Pack SOC Chart
            charts.soc = new Chart(document.getElementById('socChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Pack SOC (%)',
                        data: ts.packSOC,
                        borderColor: '#4ECDC4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#F5F5F5'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (min:sec)',
                                color: '#F5F5F5'
                            },
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'SOC (%)',
                                color: '#F5F5F5'
                            },
                            min: Math.max(0, Math.min(...ts.packSOC) - 5),
                            max: Math.min(100, Math.max(...ts.packSOC) + 5),
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Pack SOH Chart
            charts.soh = new Chart(document.getElementById('sohChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Pack SOH (%)',
                        data: ts.packSOH,
                        borderColor: '#FF6B9D',
                        backgroundColor: 'rgba(255, 107, 157, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#F5F5F5'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (min:sec)',
                                color: '#F5F5F5'
                            },
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'SOH (%)',
                                color: '#F5F5F5'
                            },
                            min: Math.max(0, Math.min(...ts.packSOH) - 2),
                            max: Math.min(100, Math.max(...ts.packSOH) + 2),
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Cell SOC Chart
            charts.cellSoc = new Chart(document.getElementById('cellSocChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Cell [0] SOC (%)',
                            data: ts.cellSOC[0],
                            borderColor: '#4ECDC4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        },
                        {
                            label: 'Cell [1] SOC (%)',
                            data: ts.cellSOC[1],
                            borderColor: '#FF6B9D',
                            backgroundColor: 'rgba(255, 107, 157, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        },
                        {
                            label: 'Cell [2] SOC (%)',
                            data: ts.cellSOC[2],
                            borderColor: '#FFD166',
                            backgroundColor: 'rgba(255, 209, 102, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#F5F5F5'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (min:sec)',
                                color: '#F5F5F5'
                            },
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'SOC (%)',
                                color: '#F5F5F5'
                            },
                            min: Math.max(0, Math.min(...ts.cellSOC.flat()) - 5),
                            max: Math.min(100, Math.max(...ts.cellSOC.flat()) + 5),
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Cell SOH Chart
            charts.cellSoh = new Chart(document.getElementById('cellSohChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Cell [0] SOH (%)',
                            data: ts.cellSOH[0],
                            borderColor: '#4ECDC4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        },
                        {
                            label: 'Cell [1] SOH (%)',
                            data: ts.cellSOH[1],
                            borderColor: '#FF6B9D',
                            backgroundColor: 'rgba(255, 107, 157, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        },
                        {
                            label: 'Cell [2] SOH (%)',
                            data: ts.cellSOH[2],
                            borderColor: '#FFD166',
                            backgroundColor: 'rgba(255, 209, 102, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#F5F5F5'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (min:sec)',
                                color: '#F5F5F5'
                            },
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'SOH (%)',
                                color: '#F5F5F5'
                            },
                            min: Math.max(0, Math.min(...ts.cellSOH.flat()) - 2),
                            max: Math.min(100, Math.max(...ts.cellSOH.flat()) + 2),
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Temperature Chart
            charts.temp = new Chart(document.getElementById('tempChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Temperature (째C)',
                        data: ts.packTemp,
                        borderColor: '#FFD166',
                        backgroundColor: 'rgba(255, 209, 102, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#F5F5F5'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (min:sec)',
                                color: '#F5F5F5'
                            },
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Temperature (째C)',
                                color: '#F5F5F5'
                            },
                            min: Math.max(0, Math.min(...ts.packTemp) - 5),
                            max: Math.max(...ts.packTemp) + 5,
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Range Chart
            charts.range = new Chart(document.getElementById('rangeChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Range (km)',
                        data: ts.packRange,
                        borderColor: '#118AB2',
                        backgroundColor: 'rgba(17, 138, 178, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#F5F5F5'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (min:sec)',
                                color: '#F5F5F5'
                            },
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Range (km)',
                                color: '#F5F5F5'
                            },
                            min: Math.max(0, Math.min(...ts.packRange) - 10),
                            max: Math.max(...ts.packRange) + 10,
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // ADDED: Pack Current Chart
            charts.current = new Chart(document.getElementById('currentChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Pack Current (A)',
                        data: ts.packCurrent,
                        borderColor: '#FF8C42',
                        backgroundColor: 'rgba(255, 140, 66, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#F5F5F5'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (min:sec)',
                                color: '#F5F5F5'
                            },
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Current (A)',
                                color: '#F5F5F5'
                            },
                            min: Math.min(0, Math.min(...ts.packCurrent) - 10),
                            max: Math.max(...ts.packCurrent) + 10,
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Acceleration Chart
            charts.accel = new Chart(document.getElementById('accelChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Acceleration (%)',
                        data: ts.acceleration,
                        borderColor: '#6A0572',
                        backgroundColor: 'rgba(106, 5, 114, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#F5F5F5'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (min:sec)',
                                color: '#F5F5F5'
                            },
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Acceleration (%)',
                                color: '#F5F5F5'
                            },
                            min: Math.min(0, Math.min(...ts.acceleration) - 10),
                            max: Math.max(...ts.acceleration) + 10,
                            ticks: {
                                color: '#F5F5F5'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function loadSampleData() {
            // Fallback to sample data if real data isn't available
            console.log('Loading sample data...');
            // You can keep your existing sample data generation here as fallback
        }

        // Initialize the dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadBMSData();
        });
    </script>
</body>
</html>
